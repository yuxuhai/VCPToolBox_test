# 分布式部署指南

当单个服务器的计算资源无法满足需求时，VCP ToolBox 的分布式部署功能就显得尤为重要。通过分布式架构，您可以将不同的插件和服务部署在多个节点上，从而实现算力的横向扩展。

## 架构概述

VCP 的分布式架构包含两种角色：

- **主服务器 (Master)**: 负责接收前端的请求，并根据需要将任务分发给不同的节点。主服务器本身也可以运行插件。
- **分布式节点 (Node)**: 运行一个或多个插件，接收主服务器分发的任务并执行。

## 何时需要分布式部署

- **资源密集型插件**: 某些插件（如图像生成、视频处理）需要大量的计算资源。将它们部署在专门的节点上，可以避免影响主服务器的性能。
- **地理位置优化**: 将节点部署在离用户更近的地方，可以降低网络延迟。
- **高可用性**: 通过多个节点提供相同的服务，可以避免单点故障。

## 如何部署

### 1. 部署主服务器

主服务器的部署方式与单机部署相同。请参考 **[部署指南](./部署指南.md)**。

您需要在主服务器的 `config.env` 文件中启用分布式功能：

```env
Enable_Distributed=true
```

### 2. 部署分布式节点

分布式节点需要使用专门的 [VCPDistributedServer](https://github.com/lioensky/VCPDistributedServer) 项目。

1.  **下载代码**:
    ```bash
    git clone https://github.com/lioensky/VCPDistributedServer.git
    cd VCPDistributedServer
    ```
2.  **安装依赖**: `npm install`
3.  **配置 `config.env`**:
    - `Master_URL`: 主服务器的地址。
    - `Node_Name`: 当前节点的唯一名称。
    - `VCP_Key`: 与主服务器 `config.env` 中的 `VCP_Key` 保持一致，用于节点和主服务器之间的认证。
    - `Plugin_List`: 在这个节点上要运行的插件列表，用逗号分隔。

    **示例 `config.env` 配置:**
    ```env
    Master_URL=http://192.168.1.100:8080
    Node_Name=gpu-node-1
    VCP_Key=your-shared-secret-key
    Plugin_List=ComfyUIGen,VideoGenerator
    ```

4.  **启动节点**: `npm start`

### 3. 在主服务器上配置插件路由

主服务器需要知道哪些插件运行在哪个节点上。在主服务器的 `config.env` 文件中，通过 `Plugin_Node_Map` 参数来配置：

```env
Plugin_Node_Map={"ComfyUIGen":"gpu-node-1", "VideoGenerator":"gpu-node-1"}
```
这个配置告诉主服务器，当需要调用 `ComfyUIGen` 或 `VideoGenerator` 插件时，应该将任务发送到名为 `gpu-node-1` 的节点。

## 工作流程

1.  前端向主服务器发送请求。
2.  AI 判断需要调用某个插件（例如 `ComfyUIGen`）。
3.  主服务器查询 `Plugin_Node_Map`，发现 `ComfyUIGen` 运行在 `gpu-node-1` 上。
4.  主服务器将任务通过 WebSocket 发送给 `gpu-node-1`。
5.  `gpu-node-1` 执行任务，并将结果返回给主服务器。
6.  主服务器将结果返回给前端。

---

通过这种方式，您可以构建一个强大、可扩展的 AI 服务集群，将不同的任务分配给最适合的硬件来处理，从而最大化资源利用率和系统性能。
